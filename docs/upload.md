# 1. Introduce

The **Upload Tool** is to upload data into Local DB. <br>
Upload Tool performs following functions:

* Upload the test data after scanConsole
* Upload the test data from the specific result directory
* Upload DCS data associated with the test data
* Upload data from cache in the stable connection
* Register chip/module data

# 2. Getting start

This page describes how to upload data into Local DB.<br>
Please look at [Installation](install.md) to set-up Upload Tool.

## Check Command & Connection

```bash
$ cd <YARR SW installation dir>
$ ./localdb/bin/localdbtool-upload init
#DB INFO# -----------------------
#DB INFO# Function: Initialize
#DB INFO# [Connection Test] DB Server: mongodb://127.0.0.1:27017/localdb
#DB INFO# ---> Connection is GOOD.
#DB INFO# -----------------------
```

**Additional options**

- **--database ``<database cfg>``**<br> : Set [database config file](config.md) (default: `${HOME}/.yarr/localdb/${HOSTNAME}_database.json`)

## Upload test data

There are two ways to upload test data into Local DB:

* `scanConsole -W` to upload test data after scanConsole immediately
* `localdbtool-upload scan` to upload test data from the specific result directory

#### scanConsole -W

You can scan and upload test data by `scanConsole -W`:

```bash
$ ./bin/scanConsole \
-r configs/controller/emuCfg.json \
-c configs/connectivity/example_fei4b_setup.json \
-s configs/scans/fei4/std_digitalscan.json \
-W
<lots of text>
#DB INFO# -----------------------
#DB INFO# Function: Initialize
#DB INFO# [Connection Test] DB Server: mongodb://127.0.0.1:27017/localdb
#DB INFO# ---> Connection is GOOD.
#DB INFO# -----------------------
#DB INFO# Uploading in the back ground. (log: ~/.yarr/localdb/log/)
```

**Additional options**

- **-d ``<database cfg>``**<br> : Set [database config file](config.md) (default: `${HOME}/.yarr/localdb/${HOSTNAME}_database.json`)
- **-u ``<user cfg>``**<br> : Set [user config file](config.md) 
- **-i ``<site cfg>``**<br> : Set [site config file](config.md)

**You have to prepare [the connectivity config file and the chip config file](#config.md) to upload upload the test data associated with the registered chip/module after the [registration](#register-chip/module-data).** 

#### localdbtool-upload scan

You can upload test data from the specific result directory by `localdbtool-upload scan`.

```bash
$ ./localdb/bin/localdbtool-upload scan <path/to/result/dir>
e.g.) $ ./localdb/bin/localdbtool-upload scan ./data/last_scan
```

**Additional options**

- **--database ``<database cfg>``**<br> : Set [database config file](config.md) (default: `${HOME}/.yarr/localdb/${HOSTNAME}_database.json`)
- **--user ``<user cfg>``**<br> : Set [user config file](config.md) 
- **--site ``<site cfg>``**<br> : Set [site config file](config.md)
- **--log**<br> : Set logging mode 'True' (default 'False'). The output log is written in `${HOME}/.yarr/localdb/log/${day}.log`
- **--username ``<username>``**<br> : Set username of the Local DB Server if the user authentication is required 
- **--password ``<password>``**<br> : Set password of the Local DB Server if the user authentication is required 
- **--config ``<config file>``**<br> : Set config file which username and password are written in if the user authentication is required

## Upload DCS data

You can upload DCS data associated with the test data for each chip data by `dbAccessor -E` 
```bash
$ ./bin/dbAccessor \
-E dcs_info.json \
-s data/last_scan/scanLog.json \
DBHandler: Register Environment:
	environmental config file : dcs_info.json
#DB INFO# -----------------------
#DB INFO# Function: Initialize
#DB INFO# [Connection Test] DB Server: mongodb://127.0.0.1:27017/localdb
#DB INFO# ---> Connection is GOOD.
#DB INFO# -----------------------
#DB INFO# Uploading in the back ground. (log: ~/.yarr/localdb/log/)
```

**Command Line Arguments**

- **-E ``<DCS cfg>``**<br> : Set [DCS config file](config.md) (json)
- **-s ``<scanLog>``**<br> : Set [scan log file](config.md) generated by scanConsole (json)

**Additional options**

- **-d ``<database cfg>``**<br> : Set [database config file](config.md) (default: `${HOME}/.yarr/localdb/${HOSTNAME}_database.json`)
- **-u ``<user cfg>``**<br> : Set [user config file](config.md) 
- **-i ``<site cfg>``**<br> : Set [site config file](config.md)

## Upload cache data

When you could not upload Scan/DCS data by `scanConsole -W`/`dbAccessor -E` because of the bad connection to Local DB Server,
the cache data and log file ('scanLog.json'/'dbDcsLog.json') would be stored in the result directory,
and that record is written to the file: `${HOME}/.yarr/run.dat`/`${HOME}/.yarr/dcs.dat`.

If the good connection to Local DB Server, you can upload all cache data by `localdbtool-upload cache`:

```bash
$ ./localdb/bin/localdbtool-upload cache
```

## Register chip/module data

You can upload test data associated with the registered chip/module after the registration.<br>

```bash
$ ./bin/dbAccessor -C -c component.json -u user.json -i site.json
<some texts>
Do you continue to upload data into Local DB? [y/n]
y

#DB INFO# Completed the upload successfuly.
#DB INFO# -----------------------
```

**Command Line Arguments**

- **-c ``<component cfg>``**<br> : Set [component config file](config.md)

This can register the components data written in component.json.

**Additional options**

- **-u ``<user cfg>``**<br> : Set [user config file](config.md) 
- **-i ``<site cfg>``**<br> : Set [site config file](config.md)

You can check the registered component data by `localdbtool-upload  check comp`:

```bash
$ ./localdb/bin/localdbtool-upload check comp
#DB INFO# -----------------------
#DB INFO# Function: Check Component Data
#DB INFO# [Connection Test] DB Server: mongodb://127.0.0.1:27017/localdb
#DB INFO# ---> Connection is GOOD.
#DB INFO# Download Component Data of Local DB locally (${HOME}/.yarr/localdb/{HOSTNAME}_modules.csv)...
#DB INFO# **************************************
#DB INFO# Component (1)
#DB INFO#     Chip Type: RD53A
#DB INFO#     Parent:
#DB INFO#         serial number: Q1
#DB INFO#         component type: module
#DB INFO#         children: 4
#DB INFO#     Child (1):
#DB INFO#         serial number: 0x0449
#DB INFO#         component type: front-end_chip
#DB INFO#         chip ID: 0
#DB INFO#     Child (2):
#DB INFO#         serial number: 0x0444
#DB INFO#         component type: front-end_chip
#DB INFO#         chip ID: 1
#DB INFO#     Child (3):
#DB INFO#         serial number: 0x0443
#DB INFO#         component type: front-end_chip
#DB INFO#         chip ID: 2
#DB INFO#     Child (4):
#DB INFO#         serial number: 0x0448
#DB INFO#         component type: front-end_chip
#DB INFO#         chip ID: 4
#DB INFO# **************************************
<some texts>
#DB INFO# The number of components: 47
#DB INFO# Done.
#DB INFO# -----------------------
```

