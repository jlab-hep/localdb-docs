# DB Accessor

The **DB Accessor** is to easy handle Local DB,<br>
mainly for component registration and DCS registration.

Contents:

0. [Command](#0-command)
1. [Getting Start](#1-getting-start)
2. [Usage](#2-usage)
    - register component data
    - register DCS data
    - upload cache data
    - retrieve component list
3. [FAQ](#3-faq)

## 0. Command

**YARR/bin/dbAccessor**

```bash
$ ./bin/dbAccessor

# optional arguments:
# -h                      : Shows help.
# -I                      : Check the connection to Local DB.
# -C                      : Upload component data into Local DB.
#     -c <component.json> : Provide component connectivity configuration.
# -R                      : Upload data into Local DB from cache.
# -E <dcs.json>           : Provide DCS configuration to upload DCS data into Local DB.
#     -s <scanLog.json>   : Provide scan log file.
# -M                      : Retrieve Module list from Local DB.
#
# -d <database.json>      : Provide database configuration. (Default HOME/.yarr/localdb/HOSTNAME_database.json)
# -i <site.json>          : Provide site configuration. (Default HOME/.yarr/localdb/HOSTNAME_site.json)
# -u <user.json>          : Provide user configuration. (Default HOME/.yarr/localdb/user.json)
```

## 1. Getting start

#### 0. Install & Setup

Please check [Pre Requirements](requirements.md) to install required packages.<br>
And please be sure to setup Local DB setting using `YARR/localdb/setup_db.sh`. <br>
This script confirms

- if the python packages is satisfied
- if the default config files are prepared
    - HOME/.yarr/localdb/HOSTNAME_database.json
    - HOME/.yarr/localdb/user.json
    - HOME/.yarr/localdb/HOSTNAME_site.json
- if the command is enabled
- if the DB connection is established

```bash
$ cd YARR
$ ./localdb/setup_db.sh

< Setting up with some texts >
```
> [More detail about setup_db.sh](setup-db.md)

#### 1. Confirmation

Please run the command with the option '-I' to check if the command is working and the connection to Local DB is good.

```bash
$ ./bin/dbAccessor -I

#DB INFO# -----------------------
#DB INFO# Function: Initialize
#DB INFO# [Connection Test] DB Server: mongodb://127.0.0.1:27017/localdb
#DB INFO# ---> Connection is GOOD.
#DB INFO# -----------------------
```

**Additional options**

- **-d ``<database.json>``**<br> : Set [database config file](config.md) (default: `HOME/.yarr/localdb/HOSTNAME_database.json`)

## 2. Usage

DB Accessor performs following functions:

* a. [Register the chip/module data](#a-register-chipmodule-data)
* b. [Register DCS data associated with the test data](#b-register-dcs-data)
* c. [Upload data from cache in the stable connection](#c-upload-cache-data)
* d. [Retrieve registered component list from Local DB](#d-retrieve-component-list)

### a. Register Chip/Module Data

You can upload test data associated with the registered chip/module after the registration.<br>
First please the prepare component config file (component.json) following [this sample format](config.md). <br>
And register by `dbAccessor -C`:

```bash
$ ./bin/dbAccessor -C \
-c component.json

Do you continue to upload data into Local DB? [y/n]
y

#DB INFO# Completed the upload successfuly.
#DB INFO# -----------------------
```

**Command Line Arguments**

- **-c ``<component cfg>``**<br> : Set [component config file](config.md)

This can register the components data written in component.json.

**Additional options**

- **-d ``<database.json>``**<br> : Set [database config file](config.md) (default: `HOME/.yarr/localdb/HOSTNAME_database.json`)
- **-u ``<user cfg>``**<br> : Set [user config file](config.md) (default: `HOME/.yarr/localdb/user.json`)
- **-i ``<site cfg>``**<br> : Set [site config file](config.md) (default: `HOME/.yarr/localdb/user.json`)

You can check the registered component data by `dbAccessor -M`.<br>
Check [Retrieve Component Data](#retrieve-component-data) to get more detail.

### b. Register DCS Data

You can register DCS data associated with the test data for each chip data.<br>
First please prepare DCS data (dcs.dat) and DCS config file (dcs_info.json) following [this sample format](config.md). <br>
And register by `dbAccessor -E`:

```bash
$ ./bin/dbAccessor \
-E dcs_info.json \
-s data/last_scan/scanLog.json

DBHandler: Register Environment:
	environmental config file : dcs_info.json
#DB INFO# -----------------------
#DB INFO# Function: Initialize
#DB INFO# [Connection Test] DB Server: mongodb://127.0.0.1:27017/localdb
#DB INFO# ---> Connection is GOOD.
#DB INFO# -----------------------
#DB INFO# Uploading in the back ground. (log: ~/.yarr/localdb/log/)
```

**Command Line Arguments**

- **-E ``<DCS cfg>``**<br> : Set [DCS config file](config.md) (json)
- **-s ``<scanLog>``**<br> : Set [scan log file](config.md) generated by scanConsole (json)

**Additional options**

- **-d ``<database.json>``**<br> : Set [database config file](config.md) (default: `HOME/.yarr/localdb/HOSTNAME_database.json`)
- **-u ``<user cfg>``**<br> : Set [user config file](config.md) (default: `HOME/.yarr/localdb/user.json`)
- **-i ``<site cfg>``**<br> : Set [site config file](config.md) (default: `HOME/.yarr/localdb/user.json`)

### c. Upload Cache Data

When you could not upload Scan/DCS data by `scanConsole -W`/`dbAccessor -E` because of the bad connection to Local DB Server, <br>
the cache data and log file ('scanLog.json'/'dbDcsLog.json') would be stored in the result directory,<br>
and that record is written to the file: `HOME/.yarr/run.dat`/`HOME/.yarr/dcs.dat`.

In the good connection to Local DB Server, you can upload all cache data by `dbAccessor -R`:

```bash
$ ./bin/dbAccessor -R
```

### d. Retrieve Component List

You can check the registered component data by `dbAccessor -M`:

```bash
$ ./bin/dbAccessor -M
#DB INFO# -----------------------
#DB INFO# Function: Check Component Data
#DB INFO# [Connection Test] DB Server: mongodb://127.0.0.1:27017/localdb
#DB INFO# ---> Connection is GOOD.
#DB INFO# Download Component Data of Local DB locally (HOME/.yarr/localdb/HOSTNAME_modules.csv)...
#DB INFO# **************************************
#DB INFO# Component (1)
#DB INFO#     Chip Type: RD53A
#DB INFO#     Parent:
#DB INFO#         serial number: 0x0001
#DB INFO#         component type: module
#DB INFO#         children: 1
#DB INFO#     Child (1):
#DB INFO#         serial number: 0x0002
#DB INFO#         component type: front-end_chip
#DB INFO#         chip ID: 0
#DB INFO# **************************************
<some texts>
#DB INFO# The number of components: 47
#DB INFO# Done.
#DB INFO# -----------------------
```

## 3. FAQ

in edit.
