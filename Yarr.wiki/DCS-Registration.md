This page describes how to upload DCS data.

### Requirements

- DAQ Server with [required libraries installed](https://github.com/jlab-hep/Yarr/wiki/Installation)
- DB Server with [required libraries installed](https://github.com/jlab-hep/Yarr/wiki/Installation)
- Setup DAQ system: [setup_db.sh](https://github.com/jlab-hep/Yarr/wiki/Setup-DAQ-Server)
- Compile scanConsole and dbAccessor 

```bash
$ cd YARR
$ git checkout devel
$ mkdir build-localdb
$ cd build-localdb
$ cmake3 ../
$ make -j4
$ make install
```

### Config files

You can store DCS data associated with the scan data by dbAccessor. <br>
Prepare the DCS config file, DCS data file, scan log file.<br>

- DCS config (json)

   **Required information**
   - 'description': the description of the DCS data
   - 'key': DCS keyword (key list is written in the database config file `${HOME}/.yarr/localdb/database.json`)
   - 'num': DCS data number (the combination of DCS keyword and this number specify the DCS data in data file)
   - 'path': path to DCS data file
   - 'status': enabled/disabled to upload data
 
   <details><summary>dcs_info.json</summary><div>
 
   ```json
   {
       "environments": [{
           "description": "VDDD Voltage [V]",
           "key": "vddd_voltage",
           "num": 0,
           "path": "dcs.dat",
           "status": "enabled"
       },{
           "description": "VDDD Current [A]",
           "key": "vddd_current",
           "num": 0,
           "path": "dcs.dat",
           "status": "enabled"
       },{
           "description": "VDDA Voltage [V]",
           "key": "vdda_voltage",
           "num": 0,
           "path": "dcs.dat",
           "status": "enabled"
       },{
           "description": "VDDA Current [A]",
           "key": "vdda_current",
           "num": 0,
           "path": "dcs.dat",
           "status": "enabled"
       },{
           "description": "High Voltage [V]",
           "key": "hv_voltage",
           "num": 0,
           "path": "dcs.dat",
           "status": "enabled"
       },{
           "description": "High Voltage Current [A]",
           "key": "hv_current",
           "num": 0,
           "path": "dcs.dat",
           "status": "enabled"
       },{
           "description": "Temperature [C]",
           "key": "temperature",
           "num": 0,
           "path": "dcs.dat",
           "status": "enabled"
       },{
           "description": "Module Temperature [C]",
           "key": "temperature",
           "num": 1,
           "path": "dcs.dat",
           "status": "enabled"
       }]
   }
   ``` 

   </div></details>

- DCS data (dat or csv)

   **Required information**
   - the 1st line: DCS keyword `key unixtime <key1> <key2> <key3> ...` 
   - the 2nd line: DCS number `num null <num1> <num2> <num3> ...`
   - the 3rd line: DCS mode `mode null <mode1> <mode2> <mode3> ...` (e.g. CV)
   - the 4th line: DCS setting value `setting null <setting1> <setting2> <setting3> ...`
   - After the 5th line: datetime and DCS data `datetime unixtime <data1> <data2> <data3> ...`
 
   <details><summary>dcs.dat</summary><div>
 
   ```dat
   key unixtime vddd_voltage vddd_current vdda_voltage vdda_current
   num null 0 0 0 0
   mode null null null null null
   setting null 10 10 10 10
   2019-06-24_20:49:13 1561376953 10 20 0 0
   2019-06-24_20:49:23 1561376963 11 21 0 0
   2019-06-24_20:49:33 1561376973 12 22 0 0
   2019-06-24_20:49:43 1561376983 13 23 0 0
   2019-06-24_20:49:53 1561376993 14 24 0 0
   2019-06-24_20:50:03 1561377003 15 25 0 0
   ```

   </div></details>

- scan log (json)
 
   In general, you should use `scanLog.json` of the specific test generated by scanConsole.
   **Required information**
   - 'startTime' or 'timestamp'

### Registration

Run the `dbAccessor -E` to upload DCS data:

```bash
$ ./bin/dbAccessor \
-E dcs_info.json \
-s data/last_scan/scanLog.json \
-m <Module serial number>
# if unregistered module, serial number should be 'DUMMY_0' (or 'DUMMY_1', 'DUMMY_2' ...)
DBHandler: Register Environment:
	environmental config file : dcs_info.json
#DB INFO# Local DB Server: mongodb://127.0.0.1:27017
#DB INFO# ---> connection is good.
#DB INFO# Uploading in the back ground. (log: ~/.yarr/localdb/log/)
```

### Confirmation

```bash
$ localdbtool-retrieve log
#DB INFO# The connection of Local DB mongodb://127.0.0.1:27017/ is GOOD.

test data ID: XXXXXXXXXXXXXXXXXXXXXXXX 
User          : kubota at Tokyo_Institute_of_Technology
Date          : 2019/07/21 03:49:37
Serial Number : DUMMY_0
Run Number    : 5576
Test Type     : std_digitalscan
DCS Data      : vddd_voltage
DCS Data      : vddd_current
```
